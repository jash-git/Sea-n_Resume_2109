!function(e,a,t,i,r){function s(e){firebase.auth().signInWithCustomToken(e)["catch"](function(e){var a=(e.code,e.message);console.log(a)})}function o(a){var t=a.split(".")[1],i=t.replaceAll("-","+").replaceAll("_","/");return JSON.parse(decodeURIComponent(escape(e.atob(i))))}function n(e){var t=o(e),i={apiKey:"AIzaSyB8iFoMoMbkc3yESmFH8efkyDrfVJK4RyA",authDomain:"hahamut-8888.firebaseapp.com",databaseURL:"https://hahamut-8888.firebaseio.com",projectId:"hahamut-8888",storageBucket:"hahamut-8888.appspot.com",messagingSenderId:"910071274434"};0==firebase.apps.length&&firebase.initializeApp(i),setTimeout(function(){var a=firebase.auth().currentUser;null==a&&s(e)},1e3),User.Login.isLogin()?a.addEventListener("visibilitychange",function(){a.hidden?h():c()}):h(),firebase.auth().onAuthStateChanged(function(e,a){if(e){if(e.uid.toLowerCase()!=User.Login.getUserid().toLowerCase())return void firebase.auth().signOut();e.getIdToken().then(function(a){var i=o(a);return e.updateProfile({displayName:i.nick}),b=i.user_id,v=i.nick,_=i.denypost,y=i.mobile,i.denypost!=t.claims.denypost||i.mobile!=t.claims.mobile?(console.log("權限變動"),void firebase.auth().signOut()):(T.getlist(),void console.log(" start login firebase "))})}})}function u(e){if(0==e)return"";var a=new Date,t=new Date(e),i=t.getFullYear(),r=a.getFullYear(),s=t.getMonth()+1,o=a.getMonth()+1,n=t.getDate(),u=a.getDate(),m=t.getHours(),d=t.getMinutes();if(10>s&&(s="0"+s),10>n&&(n="0"+n),10>o&&(o="0"+o),10>u&&(u="0"+u),10>m&&(m="0"+m),10>d&&(d="0"+d),r==i&&o==s&&u==n)var h=m+":"+d;else if(r==i)var h=s+"/"+n;else var h=i+"/"+s+"/"+n;return h}function m(e){var a=e.noreadnum;return 2==e.type?a>0?"New":"":a>999?"999+":a>0?a:""}function d(e){w[e.room]!=r&&e.field!=r&&e.room!=r&&e.value!=r&&(w[e.room][e.field]=e.value,t("#topBarMsg_hahamut").is(":hidden")||T.showlist(),"noreadnum"==e.field&&0!=e.value&&w[e.room]&&w[e.room].is_mute!==!0&&w[e.room].type&&f(!0,e.ctime),"is_inviting"==e.field&&1==e.value&&(U=!0,3!=w[e.room].type&&f(!0,e.ctime)),g()),e.room!=r&&"add"==e.room_state&&T.getlist(!0),e.room!=r&&"delete"==e.room_state&&T.getlist(!0)}function h(){0!=firebase.apps.length&&(firebase.database().goOffline(),firebase.firestore().disableNetwork(),User.Login.isLogin()||(firebase.auth().signOut(),firebase.app()["delete"]()))}function c(){firebase.database().goOnline(),firebase.firestore().enableNetwork()}function p(){t("#topBarMsg_hahamut").is(":hidden")&&(t("a#topBar_hahamut").html("<span>N</span>").addClass("topbnow4"),t("span#topBar_hahamut").html("N").show())}function l(){t("a#topBar_hahamut").html("").removeClass("topbnow4"),t("span#topBar_hahamut").html("").hide()}function f(e,a){var t={redpoint:e,redpoint_time:firebase.database.ServerValue.TIMESTAMP};"undefined"==typeof a?firebase.database().ref("/im/database/users/"+firebase.auth().currentUser.uid).update(t):firebase.database().ref("/im/database/users/"+firebase.auth().currentUser.uid+"/redpoint_time").once("value",function(e){e.val()<a&&(firebase.database().ref("/im/database/users/"+firebase.auth().currentUser.uid).update(t),p())})}function g(){localStorage.setItem("hahamut_topBar",JSON.stringify(w)),localStorage.setItem("hahamut_topBar_save_time",(new Date).getTime()),localStorage.setItem("hahamut_topBar_userid",firebase.auth().currentUser.uid)}String.prototype.replaceAll=function(e,a){var t=this;return t.replace(new RegExp(e,"g"),a)},String.prototype.giveMeColor=function(){const e=["#e57373","#f06292","#ba68c8","#9575cd","#7986cb","#64b5f6","#4fc3f7","#4dd0e1","#4db6ac","#81c784","#aed581","#ff8a65","#d4e157","#ffd54f","#ffb74d","#a1887f","#90a4ae"];var a,t,i=0;if(0===this.length)return i;for(a=0;a<this.length;a++)t=this.charCodeAt(a),i=(i<<5)-i+t,i|=0;return e[Math.abs(i)%e.length]};var b="",v="",_=!0,y=!1,w=null,k=!1,U=!1,I=[],B=!1,T={init:function(e){if(User.Login.isLogin()){var a=Cookies.get("hahamut_topBar_notify")||!1;if(setTimeout(function(){t("a#topBar_hahamut").show()},0),"true"==a&&setTimeout(function(){p()},0),1==e||B!==!1){clearTimeout(B);var i=Cookies.get("hahatoken")||"";""!=i&&n(i),""==i&&/^https:\/\/www\.gamer\.com\.tw/.test(location.href)&&t.ajax({url:"https://api.gamer.com.tw/mobile_app/im/v1/login_token.php",xhrFields:{withCredentials:!0},dataType:"json"}).done(function(e){0!=e.code&&(Cookies.set("hahatoken",e.token,{expires:1/24}),n(e.token))})}else 0==B&&"true"!=a&&(B=setTimeout(function(){ImTop.init()},1e4))}},getlist:function(e){var a=localStorage.getItem("hahamut_topBar"),i=localStorage.getItem("hahamut_topBar_save_time"),r=localStorage.getItem("hahamut_topBar_userid");null!=a&&1!=e&&null!=i&&i>(new Date).getTime()-72e5&&r==firebase.auth().currentUser.uid?(w=JSON.parse(a),t("#topBarMsg_hahamut").is(":hidden")||T.showlist(),T.listen(i)):firebase.database().ref("/im/database/users/"+firebase.auth().currentUser.uid+"/chatlist").once("value",function(a){var i=w;a.hasChildren()&&(w=a.val(),t("#topBarMsg_hahamut").is(":hidden")||T.showlist(),g(),a.forEach(function(a){a.hasChild("type")||""==a.key||(console.log("error room ",a.key),firebase.database().ref("/im/database/users/"+firebase.auth().currentUser.uid+"/chatlist/"+a.key).remove()),1==e&&"undefined"==typeof i[a.key]&&(U=!0,3!=a.child("type").val()&&f(!0,a.child("join_time").val()))})),T.listen()})},showlist:function(){var e=t("#topBarHahamut"),a=e.scrollTop();e.html(""),null!=w&&(1==U&&t("#im_friend_apply").addClass("is-notify-fd"),Object.keys(w).forEach(function(r){var s=w[r],o='<div class="im_bhtop-user-avatar"><img src="https://im.bahamut.com.tw/noimg%2Fic_head_160.png?alt=media"></div>';if(1==s.has_chat){switch(s.type){case 1:I.some(function(e){return e=="https://im.bahamut.com.tw/room%2F"+r+".jpg?alt=media"})||(o='<div class="im_bhtop-user-avatar im_bhtop-group-avatar"><img src="https://im.bahamut.com.tw/room%2F'+r+'.jpg?alt=media" onerror="ImTop.noimg(this);"></div>');break;case 2:o='<div class="im_bhtop-user-avatar" style="background-color:'+s.name.giveMeColor()+'">'+s.name.substring(0,1)+"</div>";break;case 3:case 4:I.some(function(e){return e==i.avatarUrl(r.replace(firebase.auth().currentUser.uid+"_","").replace("_"+firebase.auth().currentUser.uid,""),"S")})||(o='<div class="im_bhtop-user-avatar"><img src="'+i.avatarUrl(r.replace(firebase.auth().currentUser.uid+"_","").replace("_"+firebase.auth().currentUser.uid,""),"S")+'" onerror="ImTop.noimg(this);"></div>');break;case 5:I.some(function(e){return e==s.photo})||(o='<div class="im_bhtop-user-avatar im_bhtop-group-avatar"><img src="'+s.photo+'" onerror="ImTop.noimg(this);"></div>')}var n="",d="",h=2e9;"undefined"!=typeof s.latest_message&&(n=s.latest_message.show_text,d=u(s.latest_message.timestamp),h=2e9-parseInt(s.latest_message.timestamp/1e3),""!=d&&(d+='<i class="fa fa-clock-o"></i>'));var c="",p=t('<a href="javascript:;"></a>');p.click(function(){ImTop.open(this,r)}),p.append(o),c=t('<div class="im_bhtop-msg-item">'),c.append(t('<p class="im_bhtop-user-name"></p>').text(s.name)),"undefined"!=typeof s.is_mute&&1==s.is_mute&&c.append(t('<img class="im-volume-off" src="https://im.bahamut.com.tw/hahamut%2Fvolume_off.svg?alt=media">')),p.append(c),c=t('<div class="im_bhtop-msg-item">'),c.append(t('<p class="im_bhtop-message-summary"></p>').text(n)),"undefined"!=typeof s.noreadnum&&0!=s.noreadnum&&c.append(t('<div class="im_bhtop-message-notice"></div>').text(m(s))),p.append(c),p.append('<span class="time">'+d+"</span>");var c=t("<div></div>");c.append(p),c.css("order",h),e.append(c),e.scrollTop(a)}}))},open:function(a,i){t(a).find(".im_bhtop-message-notice").remove(),e.open("https://haha.gamer.com.tw/single.php?room="+encodeURIComponent(i),i,"width=380, height=520")},listen:function(e){if(!k||"undefined"!=typeof e){k=!0;var a=(new Date).getTime();"undefined"!=typeof e&&(a=parseInt(e),firebase.database().ref("/im/database/users/"+firebase.auth().currentUser.uid+"/changeData").off(),firebase.database().ref("/im/database/users/"+firebase.auth().currentUser.uid+"/redpoint").off()),firebase.database().ref("/im/database/users/"+firebase.auth().currentUser.uid+"/changeData").orderByChild("ctime").startAt(a).on("child_added",function(e){d(e.val())}),firebase.database().ref("/im/database/users/"+firebase.auth().currentUser.uid+"/changeData").orderByChild("ctime").startAt(a).on("child_changed",function(e){d(e.val())}),firebase.database().ref("/im/database/users/"+firebase.auth().currentUser.uid+"/redpoint").on("value",function(e){Cookies.set("hahamut_topBar_notify",e.val(),{expirest:1/12,path:"/",domain:".gamer.com.tw"}),1==e.val()?p():l()})}},close:function(){return 0==k?(this.init(!0),void setTimeout(function(){f(!1)},1e3)):void f(!1)},hasjoin:function(e){return null!=w[e]?!0:!1},noimg:function(e){I.some(function(a){return a==t(e).attr("src")})||I.push(t(e).attr("src")),t(e).attr("src","https://im.bahamut.com.tw/noimg%2Fic_head_160.png?alt=media").parent().removeClass("im_bhtop-group-avatar")}};e.ImTop=T,t(function(){ImTop.init()}),e.addEventListener("storage",function(e){"hahamut_topBar"==e.key&&ImTop.getlist()})}(window,window.document,jQuery,new BAHA_IM_LAYOUT_LIB);